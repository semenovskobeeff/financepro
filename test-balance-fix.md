# Исправления подсчета баланса счетов

## Проблемы, которые были исправлены:

1. **Неправильный подсчет баланса**: Баланс считался только по активным транзакциям, игнорируя старые операции
2. **Отсутствие автоматического обновления**: Баланс не обновлялся автоматически при создании/удалении операций
3. **Проблемы с обновлением UI**: Данные на фронтенде не обновлялись после операций

## Внесенные изменения:

### Серверная часть:

1. **BalanceService** (`server/src/modules/operations/services/balanceService.js`):

   - Изменен фильтр транзакций с `status: 'active'` на `status: { $ne: 'deleted' }`
   - Теперь учитываются все транзакции кроме удаленных

2. **Transaction middleware** (`server/src/core/domain/entities/Transaction.js`):

   - Включен middleware для автоматического пересчета баланса после сохранения транзакции
   - Добавлен middleware для пересчета баланса после удаления транзакции
   - Автоматический пересчет происходит для основного счета и целевого счета (для переводов)

3. **TransactionController** (`server/src/modules/operations/controllers/transactionController.js`):
   - Убрана дублирующая логика пересчета баланса в createTransaction и deleteTransaction
   - Теперь пересчет происходит автоматически через middleware

### Клиентская часть:

1. **TransactionAPI** (`client/src/entities/transaction/api/transactionApi.ts`):

   - Добавлена инвалидация тега 'AccountHistory' для всех операций с транзакциями
   - Это обеспечивает автоматическое обновление истории счетов

2. **AccountAPI** (`client/src/entities/account/api/accountApi.ts`):

   - Добавлен тег 'AccountHistory' для истории счетов
   - Добавлена инвалидация 'AccountHistory' в transferFunds

3. **Package.json** (`client/package.json`):
   - Добавлен скрипт "start" для запуска клиента

## Как протестировать исправления:

1. **Запустите приложение**:

   ```bash
   # В одном терминале
   cd server && npm start

   # В другом терминале
   cd client && npm start
   ```

2. **Тест 1 - Создание операции**:

   - Создайте новую операцию (доход/расход)
   - Проверьте, что баланс счета обновился автоматически без перезагрузки страницы

3. **Тест 2 - Удаление операции**:

   - Удалите существующую операцию
   - Проверьте, что баланс счета обновился автоматически

4. **Тест 3 - Перевод между счетами**:

   - Создайте перевод между счетами
   - Проверьте, что балансы обоих счетов обновились

5. **Тест 4 - Проверка старых операций**:
   - Если у вас есть старые операции, проверьте что они учитываются в балансе
   - Используйте API `/transactions/recalculate-balances` для принудительного пересчета

## API для диагностики:

- `POST /transactions/recalculate-balances` - Пересчет всех балансов
- `GET /transactions/check-balances` - Проверка корректности балансов
- `POST /transactions/sync-account/:accountId` - Синхронизация баланса конкретного счета

## Ожидаемый результат:

- Баланс счетов корректно отражает все операции (включая старые)
- Баланс автоматически обновляется при создании/удалении операций
- UI обновляется без необходимости перезагрузки страницы
- История операций по счету обновляется автоматически
