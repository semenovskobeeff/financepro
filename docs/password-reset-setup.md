# Настройка системы восстановления пароля

## Обзор

Система восстановления пароля включает в себя:

- Запрос на восстановление пароля по email
- Отправка токена восстановления на email
- Сброс пароля с использованием токена
- Валидация силы нового пароля
- Защита от злоупотреблений (rate limiting)

## Настройка переменных окружения

Создайте файл `.env` в папке `server/` на основе `env.example`:

```bash
# Email Configuration
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password

# Client URL для ссылок в письмах
CLIENT_URL=http://localhost:3000
```

### Настройка Gmail

1. Включите двухфакторную аутентификацию в Google аккаунте
2. Создайте пароль приложения:
   - Перейдите в настройки Google аккаунта
   - Безопасность → Пароли приложений
   - Создайте новый пароль для приложения
   - Используйте этот пароль в `EMAIL_PASS`

### Другие почтовые провайдеры

#### Yandex

```
EMAIL_HOST=smtp.yandex.ru
EMAIL_PORT=465
EMAIL_SECURE=true
```

#### Mail.ru

```
EMAIL_HOST=smtp.mail.ru
EMAIL_PORT=465
EMAIL_SECURE=true
```

## Безопасность

### Валидация паролей

Новые пароли должны содержать:

- Минимум 8 символов
- Заглавную букву (A-Z)
- Строчную букву (a-z)
- Цифру (0-9)
- Специальный символ (@$!%\*?&)

### Rate Limiting

- Запрос восстановления: 3 попытки за 5 минут на IP+email
- Сброс пароля: 10 попыток за 5 минут на IP
- Вход в систему: 5 попыток за 15 минут на IP

### Защита токенов

- Токены действительны 1 час
- Токены одноразовые (нельзя использовать повторно)
- Проверка активности пользователя
- Новый пароль должен отличаться от текущего

## API Endpoints

### POST /api/users/forgot-password

Запрос на восстановление пароля

**Тело запроса:**

```json
{
  "email": "user@example.com"
}
```

**Ответ:**

```json
{
  "message": "Если ваш email зарегистрирован, вы получите письмо для сброса пароля."
}
```

### POST /api/users/reset-password

Сброс пароля с токеном

**Тело запроса:**

```json
{
  "token": "40-character-hex-token",
  "password": "NewSecurePassword123!"
}
```

**Ответ:**

```json
{
  "message": "Пароль успешно сброшен."
}
```

## Фронтенд компоненты

### ForgotPasswordPage

- Форма ввода email
- Валидация email
- Отображение статуса отправки

### ResetPasswordPage

- Форма ввода нового пароля
- Подтверждение пароля
- Индикатор силы пароля
- Валидация требований к паролю

### PasswordStrengthIndicator

- Визуальный индикатор силы пароля
- Список требований с отметками
- Цветовая индикация уровня безопасности

## Тестирование

### Локальное тестирование

Для тестирования без реального SMTP сервера используйте [Ethereal Email](https://ethereal.email/):

```javascript
// В userController.js
console.log('Preview URL: %s', nodemailer.getTestMessageUrl(info));
```

### Проверка функциональности

1. Запросите восстановление пароля
2. Проверьте получение письма
3. Перейдите по ссылке из письма
4. Введите новый пароль
5. Войдите с новым паролем

## Возможные ошибки

### Ошибки отправки email

- Проверьте настройки SMTP
- Убедитесь в правильности учетных данных
- Проверьте настройки безопасности почтового провайдера

### Ошибки валидации

- Проверьте формат токена (40 символов hex)
- Убедитесь в соответствии пароля требованиям
- Проверьте срок действия токена

### Rate Limiting

- Подождите указанное время
- Проверьте настройки лимитов в коде
- Очистите кеш rate limiter при необходимости

## Мониторинг

Логи системы восстановления пароля включают:

- Отправку писем восстановления
- Успешные сбросы паролей
- Ошибки валидации
- Превышение лимитов запросов

Рекомендуется настроить мониторинг этих событий в production среде.
